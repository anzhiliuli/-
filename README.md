# 碧蓝档案轴计算器

一个用于规划和计算碧蓝档案角色技能释放时间轴的网页应用程序。

## 功能特性

### 核心功能
- 🎭 **角色管理**：添加、编辑和删除角色，设置回费速度、技能费用等属性
- 📊 **数据管理**：添加、编辑和删除数据项，记录技能释放时间、费用等信息
- ⚙️ **关联规则**：设置角色间的关联规则，影响费用计算和回费效果
  - 减费效果：减少目标角色的技能费用
  - 更改扣除：直接修改费用扣除值
  - 费用效果：增加或减少回费速度
- 📈 **时间轴视图**：可视化展示技能释放时间轴和费用变化曲线
- 💾 **数据导入/导出**：支持JSON格式的数据导入和导出

### 高级功能
- ⏱️ **持续回费功能**：选择目标行，设置延迟时间、持续时长和回费速度增加
- ✨ **角色特殊技能**：支持角色特殊技能的费用计算
- 🎯 **数据筛选**：根据角色、时间范围筛选数据项
- 🔄 **自动计算**：自动计算技能释放的时间间隔和费用变化
- 📱 **响应式设计**：适配不同屏幕尺寸

## 技术栈

- **前端框架**：原生JavaScript (ES Modules)
- **样式框架**：Tailwind CSS 风格
- **图表库**：Chart.js
- **图标库**：Font Awesome
- **开发服务器**：http-server

## 项目结构

```
src/
├── css/
│   ├── components/      # 组件样式
│   ├── layouts/         # 布局样式
│   ├── themes/          # 主题样式
│   ├── utils/           # 工具样式
│   ├── main.css         # 主样式文件
│   └── rule-styles.css  # 规则相关样式
└── js/
    ├── components/      # UI组件
    ├── core/            # 核心应用逻辑
    ├── managers/        # 管理器
    │   ├── calculator.js        # 计算器管理器
    │   ├── dataManager.js       # 数据管理器
    │   ├── eventListeners.js    # 事件监听器
    │   ├── modalManager.js      # 模态框管理器
    │   └── uiRenderer.js        # UI渲染器
    ├── utils/           # 工具函数
    └── index.js         # 入口文件
```

## 安装和运行

### 环境要求
- Node.js (建议使用 v14 或更高版本)

### 安装依赖

```bash
npm install
```

### 启动开发服务器

```bash
npm run dev
```

应用将在 `http://localhost:8000` 启动。

### 构建生产版本

本项目为静态网页应用，直接部署 `index.html` 和 `src/` 目录即可。

## 使用指南

### 快速开始

1. **初始化数据表**：点击"初始化数据表"按钮，设置初始时间
2. **添加角色**：点击"添加角色"按钮，输入角色信息
3. **添加数据项**：在"添加数据项"区域选择角色，输入触发费用和动作
4. **设置关联规则**：点击"添加规则"按钮，设置角色间的关联规则
5. **查看时间轴**：点击"显示时间线"按钮，查看技能释放时间轴和费用变化曲线

### 详细使用说明

#### 1. 角色管理

- **添加角色**：
  - 点击左侧面板的"添加"按钮
  - 输入角色名称、回费速度、技能费用等信息
  - 可选：启用回费功能，设置回费增加百分比

- **编辑角色**：
  - 在角色列表中点击"编辑"按钮
  - 修改角色信息
  - 点击"保存"按钮

- **删除角色**：
  - 在角色列表中点击"删除"按钮
  - 确认删除

#### 2. 数据管理

- **添加数据项**：
  - 在"添加数据项"区域选择触发角色
  - 输入触发费用和动作
  - 点击"添加数据项"按钮

- **编辑数据项**：
  - 在数据表中点击"编辑"按钮
  - 修改数据项信息
  - 点击"保存"按钮

- **删除数据项**：
  - 在数据表中点击"删除"按钮
  - 确认删除
  - **自动删除关联规则**：删除数据项时，关联的规则会自动删除

- **批量删除数据项**：
  - 选择多个数据项
  - 点击"批量删除"按钮
  - 确认删除
  - **自动删除关联规则**：批量删除数据项时，关联的规则会自动删除

#### 3. 角色关联设置

角色关联设置是本计算器的核心功能之一，允许您设置角色之间的关联规则，影响费用计算和回费效果。

##### 3.1 关联规则

关联规则用于设置角色之间的相互影响，包括减费效果、更改扣除和费用效果三种类型。

**使用步骤**：
1. 在数据表中选择一行作为目标行（点击行首复选框或行内任意位置）
2. 点击左侧面板的"添加规则"按钮
3. 在弹出的模态框中设置规则参数
4. 点击"保存"按钮

**规则类型说明**：

- **减费效果**：
  - 作用：减少目标角色的技能费用
  - 设置项：
    - 触发角色：触发该规则的角色
    - 目标角色：受到减费效果的角色
    - 生效次数：减费效果可以生效的次数
    - 减费数值：每次使用减少的费用值
  - 注意：后添加的减费规则优先级更高，会覆盖之前的减费效果

- **更改扣除**：
  - 作用：直接修改目标行的费用扣除值
  - 设置项：
    - 触发角色：触发该规则的角色
    - 更改数值：直接设置的费用扣除值
  - 注意：该规则仅对目标行生效，会覆盖所有其他费用计算

- **费用效果**：
  - 作用：增加或减少回费速度
  - 设置项：
    - 触发角色：触发该规则的角色
    - 目标角色：受到回费效果影响的角色
    - 生效时间：规则开始生效的时间（秒）
    - 持续时间：规则持续生效的时间（秒）
    - 费用类型：百分比增加/减少或固定数值增加/减少
    - 数值：回费速度的变化量
  - 注意：费用效果在指定时间范围内生效，会影响所有符合条件的角色

##### 3.2 持续回费功能

持续回费功能允许您为特定技能释放设置持续的回费效果。

**使用步骤**：
1. 在数据表中选择一行作为目标行（点击行首复选框）
2. 点击左侧面板的"持续回费功能"按钮
3. 在弹出的模态框中设置参数：
   - 延迟时间：从目标行到回费效果开始的时间间隔（秒）
   - 持续时长：回费效果持续的时间（秒）
   - 回费速度增加：回费速度的增加量（c/s）
4. 点击"保存"按钮

**效果**：
- 在目标行的时间点 - 延迟时间 开始生效
- 持续 持续时长 秒后结束
- 期间所有角色的总回费速度增加 指定数值
- 常用于模拟角色技能带来的持续回费效果

##### 3.3 角色特殊技能

角色特殊技能功能允许您设置和计算角色的特殊技能费用。

**使用步骤**：
1. 点击左侧面板的"角色特殊技能"按钮
2. 在弹出的模态框中查看和设置特殊技能
3. 选择要应用的特殊技能
4. 点击"保存"按钮

**效果**：
- 特殊技能的费用会自动应用到相关数据项中
- 支持不同角色的特殊技能费用计算

#### 4. 时间轴视图

- **查看时间轴**：
  - 点击右侧面板的"显示时间线"按钮
  - 在时间轴视图中查看技能释放事件
  - 查看费用变化曲线
  - 可按角色筛选时间轴
  - 可查看每个技能释放的详细信息

#### 5. 自动计算功能

自动计算功能可以根据时间或费用的变化，自动计算对应的费用或时间。

**使用场景**：
- 编辑数据项时，修改时间会自动计算对应的触发费用
- 编辑数据项时，修改触发费用会自动计算对应的时间
- 支持各种时间格式（MM:SS.fff、MM:SS、SS.fff、SS、纯数字）
- 微小的时间或费用变化都会触发自动计算

**计算逻辑**：
- 考虑上一个数据项的剩余费用
- 基于所有角色的总回费速度
- 使用毫秒级精度进行模拟计算
- 确保与完整的费用回费计算逻辑一致

## 费用计算逻辑

### 基础费用计算
```
技能费用 = 基础技能费用 + 每使用一次的额外费用 * (使用次数 - 1)
```

**示例**：某角色基础技能费用为10c，每使用一次额外增加1c，第3次使用时的费用为：
```
技能费用 = 10 + 1 * (3 - 1) = 12c
```

### 减费效果计算
```
最终费用 = 基础费用 - 减费值
```

**注意**：
- 后应用的减费效果会覆盖之前的减费效果，而非叠加
- 减费效果有生效次数限制，超过次数后不再生效

**示例**：某角色基础技能费用为10c，有一个减费效果减少2c，生效次数为2次：
- 第1次使用：最终费用 = 10 - 2 = 8c
- 第2次使用：最终费用 = 10 - 2 = 8c
- 第3次使用：最终费用 = 10 - 0 = 10c（减费效果已用尽）

### 回费计算

回费计算采用细粒度时间步长模拟（0.001秒精度），确保计算准确性：

```
回费量 = 回费速度 * 时间间隔
```

**示例**：角色总回费速度为2.5c/s，时间间隔为3秒：
```
回费量 = 2.5 * 3 = 7.5c
```

### 持续回费效果

持续回费效果会在指定时间范围内增加总回费速度：

```
总回费速度 = 基础回费速度 + 持续回费增加量
```

**示例**：
- 基础总回费速度：2.5c/s
- 持续回费增加量：1.0c/s
- 持续时间：5秒
- 期间总回费速度：2.5 + 1.0 = 3.5c/s
- 5秒内额外回费：1.0 * 5 = 5c

### 自动计算逻辑

编辑数据项时，自动计算功能会：
1. 获取上一个数据项的剩余费用
2. 基于当前时间和上一个时间的时间间隔
3. 使用细粒度时间步长（0.001秒）模拟费用恢复
4. 计算新的触发费用

**时间到费用计算**：
```
新费用 = 上一个剩余费用 + (上一个时间 - 当前时间) * 回费速度
```

**费用到时间计算**：
```
所需时间 = (目标费用 - 上一个剩余费用) / 回费速度
```

## 数据结构

### 角色数据
```javascript
{
  id: 1,
  name: '角色名称',
  costRecoveryRate: 2.5, // 回费速度 (c/s)
  skillCost: 10.0,       // 技能费用 (c)
  costIncrease: 0.0,     // 每使用一次的额外费用
  isChargePercentage: false // 是否启用回费百分比
}
```

### 数据项数据
```javascript
{
  id: 1,
  characterId: 1,        // 角色ID
  cost: 10.0,            // 触发费用 (c)
  action: '技能',         // 动作类型
  time: 0,               // 时间 (秒)
  timeInterval: 0,       // 与上一项的时间间隔 (秒)
  costDeduction: 0,      // 费用扣除 (c)
  remainingCost: 0       // 剩余费用 (c)
}
```

### 关联规则数据
```javascript
{
  id: 1,
  type: 'costReduction', // 规则类型
  characterId: 1,        // 角色ID
  targetCharacterIds: [2], // 目标角色ID数组
  effectCount: 3,        // 生效次数
  reductionValue: 2.0    // 减费值
}
```

## 浏览器兼容性

- Chrome (推荐)
- Firefox
- Safari
- Edge

## 开发说明

### 代码规范
- 使用 ES Modules
- 采用类和模块化设计
- 使用 Tailwind CSS 风格的样式命名
- 代码注释清晰

### 调试
- 支持浏览器开发者工具调试
- 控制台输出调试信息

## 更新日志

### v2.0.0 (2025-12-24)
- 重构项目结构，采用模块化设计
- 新增时间轴视图功能
- 新增持续回费功能
- 新增角色特殊技能
- 优化数据管理和关联规则系统
- 改进UI设计，支持响应式布局

### v1.0.0 (2025-01-01)
- 初始版本
- 基本的角色管理和数据管理功能
- 简单的费用计算逻辑

## 贡献指南

欢迎提交Issue和Pull Request！

### 提交规范
- 代码风格保持一致
- 提交信息清晰明了
- 测试新功能

## 许可证

MIT License

## 联系方式

如有问题或建议，请通过以下方式联系：

- QQ：[1441736707]
- 电子邮件：[1441736707@qq.com]

---

© 2025 碧蓝档案轴计算器 | 版本 2.0.0
